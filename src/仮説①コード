# 仮説1:予測への寄与が高かったOT, LULL, LUFLから更なる特徴量を生成していくことでより精度が高まるのでは?
df_hypo = df_feat.copy()
df_hypo['sum_low_load'] = df_hypo["LUFL"] + df_hypo["LULL"]
df_hypo['LULL_OT_inter']  = df_hypo['LULL'] * df_hypo['OT']
df_hypo['LUFL_OT_inter']  = df_hypo['LUFL'] * df_hypo['OT']

#欠損値処理
columns = df_hypo.columns.difference(['OT','sin_24h','cos_24h'])
TEST_SIZE = 24
train_df = df_hypo.iloc[:-TEST_SIZE] # 検証データの隔離
non_stationary_cols = []

# 非定常カラムの特定
for col in columns:
    series = train_df[col]
    kpss_stat, kpss_p, *_ = kpss(series, regression='ct')
    if kpss_p > 0.05:
        print(f'定常 {col}: KPSS p={kpss_p}')
    else:
        print(f'非定常 {col}: KPSS p={kpss_p}')
        non_stationary_cols.append(col)

# 非定常カラムのみ差分を取る
for col in non_stationary_cols:
    df_hypo[col] = df_hypo[col].diff()

df_hypo = df_hypo.dropna()

# 定常性再確認
columns = df_hypo.columns
for col in columns:
    series = df_hypo[col]
    series = series.replace([np.inf, -np.inf], np.nan).dropna()
    kpss_stat, kpss_p, *_ = kpss(series, regression='ct')
    if kpss_p > 0.05:
       print(f'定常 {col}: KPSS p={kpss_p}')
    else:df_horizon = make_24h_horizon(df_hypo)

X_train, y_train, X_test, y_test = split_scale(df_horizon)
model, best_params, cv_mae = train_best_lgb(X_train, y_train)
metrics = evaluate(model, X_test, y_test)

# テスト予測
y_pred = model.predict(X_test, num_iteration=model.best_iteration_)
y_true = y_test  # テスト区間の実測値
y_pred = pd.Series(y_pred, index=y_test.index)

# 実測値と予測値のプロット
plt.figure(figsize=(10, 5))
plt.plot(y_true, label='original')
plt.plot(y_pred, '--', label='predict')
plt.legend()
plt.show()

#各特徴量の寄与度の確認
importances = pd.Series(
    model.feature_importances_,
    index=X_train.columns
).sort_values(ascending=False)

df_imp = importances.reset_index().rename(columns={'index': 'feature', 0: 'importance'})
importances = importances[:50]
plt.figure(figsize=(10, 6))
importances.plot(kind='bar')
plt.title("Feature Importances")
plt.xlabel("Feature")
plt.ylabel("Importance")
plt.tight_layout()
plt.show()

plot_importance(model,max_num_features=15, height=0.5, figsize=(10, 8))  # 上位20個のみ表示
plt.show()
